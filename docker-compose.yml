# Docker Compose for Debian Desktop
# Usage: docker compose up -d

name: desktop

services:
  desktop:
    build:
      context: ./docker/kasmvnc
      args:
        - USERNAME=${USERNAME:-user}
        - USER_UID=${USER_UID:-1000}
        - USER_GID=${USER_GID:-1000}
    image: desktop:${IMAGE_TAG:-latest}
    hostname: desktop
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_PTRACE
    shm_size: 2gb
    ports:
      - "${VNC_PORT:-5901}:5901"
      - "${VNC_WEB_PORT:-6901}:6901"
      - "${XRDP_PORT:-3389}:3389"
      - "${NOMACHINE_PORT:-4000}:4000"
    environment:
      # User configuration
      - USERNAME=${USERNAME:-user}
      - USER_UID=${USER_UID:-1000}
      - USER_GID=${USER_GID:-1000}
      - USER_PASSWORD=${USER_PASSWORD:-}
      # Display configuration
      - DISPLAY=${DISPLAY:-:1}
      - RESOLUTION=${RESOLUTION:-1920x1080x24}
      - TZ=${TZ:-UTC}
      # VNC configuration
      - VNC_PW=${VNC_PW:-vncpassword}
      - VNC_VIEW_ONLY_PW=${VNC_VIEW_ONLY_PW:-}
      - VNC_PORT=${VNC_PORT:-5901}
      - VNC_WEB_PORT=${VNC_WEB_PORT:-6901}
      - VNC_RESOLUTION=${VNC_RESOLUTION:-1920x1080}
      - VNC_COL_DEPTH=${VNC_COL_DEPTH:-24}
      # KasmVNC features
      - KASMVNC_ENABLE_SSL=${KASMVNC_ENABLE_SSL:-false}
      - KASM_SVC_AUDIO=${KASM_SVC_AUDIO:-1}
      - KASM_SVC_AUDIO_INPUT=${KASM_SVC_AUDIO_INPUT:-1}
      - KASM_SVC_UPLOADS=${KASM_SVC_UPLOADS:-1}
      - KASM_SVC_DOWNLOADS=${KASM_SVC_DOWNLOADS:-1}
      # Plugin configuration (comma-separated: brew,chrome,vscode,cursor,xrdp,nomachine,claude-code,docker,antigravity,opencode)
      - PLUGINS=${PLUGINS:-}
      # Homebrew
      - HOMEBREW_NO_AUTO_UPDATE=${HOMEBREW_NO_AUTO_UPDATE:-1}
      - HOMEBREW_NO_ANALYTICS=${HOMEBREW_NO_ANALYTICS:-1}
    volumes:
      - desktop-home:/home/${USERNAME:-user}
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # Uncomment for Docker socket passthrough (alternative to PLUGINS=docker DinD):
      # - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD-SHELL", "curl -sfk http://localhost:6901/ || curl -sfk https://localhost:6901/"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

volumes:
  desktop-home:
    name: ${COMPOSE_PROJECT_NAME:-desktop}-home

networks:
  default:
    name: ${COMPOSE_PROJECT_NAME:-desktop}-network
